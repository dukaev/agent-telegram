name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  npm-publish:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Download binaries from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p binaries

          # Download and extract all platform binaries
          for platform in darwin linux; do
            for arch in amd64 arm64; do
              echo "Downloading ${platform}_${arch}..."
              gh release download v${VERSION} \
                --repo ${{ github.repository }} \
                --pattern "agent-telegram_${VERSION}_${platform}_${arch}.tar.gz" \
                --dir /tmp
              tar -xzf /tmp/agent-telegram_${VERSION}_${platform}_${arch}.tar.gz -C /tmp
              mv /tmp/agent-telegram binaries/agent-telegram-${platform}-${arch}
              chmod +x binaries/agent-telegram-${platform}-${arch}
            done
          done

          # Windows binaries
          for arch in amd64 arm64; do
            echo "Downloading windows_${arch}..."
            gh release download v${VERSION} \
              --repo ${{ github.repository }} \
              --pattern "agent-telegram_${VERSION}_windows_${arch}.zip" \
              --dir /tmp
            unzip -o /tmp/agent-telegram_${VERSION}_windows_${arch}.zip -d /tmp
            mv /tmp/agent-telegram.exe binaries/agent-telegram-windows-${arch}.exe
          done

          ls -la binaries/

      - name: Update package version from tag
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Publish to npm (OIDC)
        run: npm publish --access public --provenance
